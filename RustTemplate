#![allow(non_snake_case, dead_code, unused_variables)]

use std::sync::{Arc, Mutex};
use std::rc::Rc;
use std::borrow::Borrow;
// [[EXTRA IMPORTS]]

/*
type B<T> = Arc<Mutex<T>>;
macro_rules! grab_B {
    ($x:expr) => { ($x).lock().unwrap() }
}
macro_rules! new_B {
    ($x:expr) => { Arc::new(Mutex::new($x)) }
}
*/
type B<T> = Rc<T>;
macro_rules! grab_B {
    ($x:expr) => { $x.borrow() }
}
macro_rules! new_B {
    ($x:expr) => { Rc::new($x) }
}

// do I need the derives?
#[derive(Clone, Debug)]
enum Monotype<T> {
// [[TYPE]]
}

// do I need the derives?
#[derive(Clone, Debug)]
enum Thunk {
  Ctor(Monotype<B<Thunk>>),
  Eval(B<Thunk>, B<Thunk>),
  Thunk(B<Thunk>),
}

fn new_ctor(a: Monotype<B<Thunk>>) -> B<Thunk> {
  new_B!(Thunk::Ctor(a))
}

fn new_eval(a: B<Thunk>, b: B<Thunk>) -> B<Thunk> {
  new_B!(Thunk::Eval(a, b))
}

fn eval(a: &Monotype<B<Thunk>>, b: B<Thunk>) -> Option<Thunk> {
  match a {
// [[EVAL]]
  }
}

fn simplify(v: B<Thunk>) {
  let mut stack = Vec::new();
  stack.push(v);

  loop {
    // println!("{}", stack.len());
    match stack.pop() {
      None => { break; }
      Some(x) => {
        let mut xv = grab_B!(x);
        match xv.clone() {
          Thunk::Ctor(_) => {}
          Thunk::Thunk(a) => {
            let av = grab_B!(a);
            match &*av {
              Thunk::Ctor(m) => {
                *xv = Thunk::Ctor(m.clone());
              }
              _ => {
                stack.push(x.clone());
                stack.push(a.clone());
              }
            }
          }
          Thunk::Eval(a, b) => {
            let av = grab_B!(a);
            match &*av {
              Thunk::Ctor(m) => {
                stack.push(x.clone());
                match eval(m, b.clone()) {
                  Some(a) => { *xv = a; }
                  None => { stack.push(b.clone()); }
                };
              }
              _ => {
                stack.push(x.clone());
                stack.push(a.clone());
              }
            }
          }
        }
      }
    }
  }
}

// [[MAIN]]
